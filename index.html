<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mac Votes - Blockchain Voting System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Optional Buffer polyfill for some wallet libs (safely guarded) -->
    <script>
        try {
            if (!window.Buffer && window.buffer && window.buffer.Buffer) {
                window.Buffer = window.buffer.Buffer;
            }
        } catch {}
        window.global = window.global || window;
        window.process = window.process || { env: {} };
    </script>
    
    <!-- Solana Core Libraries (specific versions that work) -->
    <script src="https://unpkg.com/@solana/web3.js@1.87.6/lib/index.iife.js"></script>
    <!-- Utility: bs58 for base58 encode/decode (used in admin sign-in flow) -->
    <script src="https://unpkg.com/bs58@5.0.0/dist/index.umd.js"></script>
    
    <!-- Simple wallet detection script -->
    <script>
        window.detectWallet = function() {
            // Check for Phantom
            if (typeof window.phantom !== 'undefined' && window.phantom.solana && window.phantom.solana.isPhantom) {
                return window.phantom.solana;
            }
            // Check for other Solana wallets
            if (typeof window.solana !== 'undefined' && window.solana.isPhantom) {
                return window.solana;
            }
            // Check for SolanaWeb3 providers
            if (typeof window.solanaWeb3 !== 'undefined') {
                console.log('‚úÖ SolanaWeb3 loaded');
            }
            return null;
        };
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .card-shadow { box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .pulse-animation { animation: pulse 2s infinite; }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        .vote-button:hover { transform: translateY(-2px); transition: all 0.3s ease; }
        .blockchain-badge { background: linear-gradient(45deg, #f093fb 0%, #f5576c 100%); }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Navigation -->
    <nav class="gradient-bg text-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-white rounded-lg flex items-center justify-center">
                        <span class="text-2xl">üó≥Ô∏è</span>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold">Mac Votes</h1>
                        <p class="text-xs opacity-90">Blockchain Voting System</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="blockchain-badge px-3 py-1 rounded-full text-xs font-medium">
                        üîó Solana Powered
                    </div>
                    <button id="adminBtn" class="bg-white bg-opacity-20 hover:bg-opacity-30 px-4 py-2 rounded-lg text-sm font-medium transition-all">
                        Admin Panel
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Container -->
    <div class="max-w-6xl mx-auto px-4 py-8">
        <!-- Login Section -->
        <div id="loginSection" class="max-w-md mx-auto">
            <div class="bg-white rounded-2xl card-shadow p-8">
                <div class="text-center mb-8">
                    <div class="w-16 h-16 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full flex items-center justify-center mx-auto mb-4">
                        <span class="text-2xl text-white">üéì</span>
                    </div>
                    <h2 class="text-2xl font-bold text-gray-800 mb-2">Student Login</h2>
                    <p class="text-gray-600">Enter your matriculation number to begin</p>
                </div>

                <div class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Matriculation Number</label>
                        <input type="text" id="matricInput" placeholder="e.g., DE.2021/4311" 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
                        <div id="matricStatus" class="mt-2 text-sm hidden"></div>
                    </div>

                    <button id="connectWalletBtn" disabled 
                            class="w-full bg-gray-300 text-gray-500 py-3 rounded-lg font-medium cursor-not-allowed transition-all">
                        üîí Verify Matric First
                    </button>

                    <div id="walletInfo" class="hidden bg-green-50 border border-green-200 rounded-lg p-4">
                        <div class="flex items-center space-x-2">
                            <span class="text-green-600">‚úÖ</span>
                            <span class="text-sm font-medium text-green-800">Wallet Connected</span>
                        </div>
                        <p id="walletAddress" class="text-xs text-green-600 mt-1 font-mono"></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Voting Section -->
        <div id="votingSection" class="hidden">
            <div id="noElectionsMessage" class="hidden text-center py-16">
                <div class="w-24 h-24 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-6">
                    <span class="text-4xl text-gray-400">üì≠</span>
                </div>
                <h2 class="text-2xl font-bold text-gray-800 mb-2">No Elections Available</h2>
                <p class="text-gray-600 mb-6">There are currently no active elections. Please check back later.</p>
                <button onclick="goBackToLogin()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-medium">
                    Back to Login
                </button>
            </div>

            <div id="activeElectionContent">
                <div class="text-center mb-8">
                    <h2 class="text-3xl font-bold text-gray-800 mb-2">Elections</h2>
                    <p class="text-gray-600">Select an election to view candidates and vote</p>
                </div>

                <div id="electionCards" class="grid md:grid-cols-2 gap-6 mb-8"></div>

                <div id="electionDetail" class="hidden bg-white rounded-2xl card-shadow p-6 mb-8">
                    <div class="flex items-center justify-between mb-3">
                        <div>
                            <h3 id="detailTitle" class="text-xl font-bold text-gray-800 mb-1"></h3>
                            <p id="detailMeta" class="text-sm text-gray-500"></p>
                        </div>
                        <div class="flex items-center space-x-2 text-sm">
                            <span id="electionStatus" class="bg-green-100 text-green-800 px-3 py-1 rounded-full font-medium">LIVE</span>
                            <span id="totalVotes" class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full font-medium">üìä Total Votes: 0</span>
                        </div>
                    </div>
                    <p id="detailDesc" class="text-gray-600"></p>
                </div>
            </div>

            <!-- Dynamic Candidates Grid (hidden until an election is selected) -->
            <div id="candidatesGrid" class="hidden grid md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8"></div>

            <!-- Vote Confirmation -->
            <div id="voteConfirmation" class="hidden bg-green-50 border border-green-200 rounded-2xl p-6">
                <div class="text-center">
                    <div class="w-16 h-16 bg-green-500 rounded-full flex items-center justify-center mx-auto mb-4">
                        <span class="text-2xl text-white">‚úÖ</span>
                    </div>
                    <h3 class="text-xl font-bold text-green-800 mb-2">Vote Cast Successfully!</h3>
                    <p class="text-green-700 mb-4">Your vote has been recorded on the Solana blockchain.</p>
                    <div class="bg-white rounded-lg p-4 text-left">
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div>
                                <span class="text-gray-500">Candidate:</span>
                                <p id="votedCandidate" class="font-medium"></p>
                            </div>
                            <div>
                                <span class="text-gray-500">Transaction ID:</span>
                                <p id="transactionId" class="font-mono text-xs break-all"></p>
                            </div>
                            <div>
                                <span class="text-gray-500">Timestamp:</span>
                                <p id="voteTimestamp" class="font-medium"></p>
                            </div>
                            <div>
                                <span class="text-gray-500">Status:</span>
                                <p class="text-green-600 font-medium">‚úÖ Confirmed</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Admin Panel -->
        <div id="adminPanel" class="hidden">
            <div class="bg-white rounded-2xl card-shadow p-8">
                <div class="flex items-center justify-between mb-8">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800">Admin Panel</h2>
                        <p class="text-gray-600">Manage elections and view voting data</p>
                    </div>
                    <button id="closeAdminBtn" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg">
                        Close
                    </button>
                </div>

                <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="bg-blue-50 rounded-lg p-4">
                        <div class="text-2xl font-bold text-blue-600">247</div>
                        <div class="text-sm text-blue-800">Total Votes Cast</div>
                    </div>
                    <div class="bg-green-50 rounded-lg p-4">
                        <div class="text-2xl font-bold text-green-600" id="registeredCount">‚Äî</div>
                        <div class="text-sm text-green-800">Registered Voters</div>
                    </div>
                    <div class="bg-purple-50 rounded-lg p-4">
                        <div class="text-2xl font-bold text-purple-600">3</div>
                        <div class="text-sm text-purple-800">Active Elections</div>
                    </div>
                    <div class="bg-orange-50 rounded-lg p-4">
                        <div class="text-2xl font-bold text-orange-600">89%</div>
                        <div class="text-sm text-orange-800">Participation Rate</div>
                    </div>
                </div>

                <div class="space-y-6">
                    <div class="flex space-x-4">
                        <button onclick="createElection()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-medium">
                            ‚ûï Create Election
                        </button>
                        <button onclick="downloadCSV()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-medium">
                            üìä Download CSV
                        </button>
                        <button onclick="verifyWinner()" class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 rounded-lg font-medium">
                            üèÜ Verify Winner
                        </button>
                        <button onclick="openVoterModal()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-3 rounded-lg font-medium">
                            üë§ Add Voter
                        </button>
                    </div>

                    <!-- Election Management Table -->
                    <div class="overflow-x-auto">
                        <table class="w-full border-collapse border border-gray-200 rounded-lg">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="border border-gray-200 px-4 py-3 text-left text-sm font-medium text-gray-700">Election</th>
                                    <th class="border border-gray-200 px-4 py-3 text-left text-sm font-medium text-gray-700">Status</th>
                                    <th class="border border-gray-200 px-4 py-3 text-left text-sm font-medium text-gray-700">Votes</th>
                                    <th class="border border-gray-200 px-4 py-3 text-left text-sm font-medium text-gray-700">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="electionTableBody">
                                <!-- Elections will be populated here -->
                            </tbody>
                        </table>
                    </div>
                    <div class="mt-10">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="text-lg font-bold text-gray-800">Voters</h3>
                            <div class="flex items-center space-x-2">
                                <input id="voterSearch" placeholder="Search name/matric/email" class="px-3 py-2 border border-gray-300 rounded-lg text-sm w-64" />
                                <button onclick="refreshVoters()" class="px-3 py-2 border border-gray-300 rounded-lg text-sm">Refresh</button>
                            </div>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full border-collapse border border-gray-200 rounded-lg">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="border border-gray-200 px-3 py-2 text-left text-sm text-gray-700">Name</th>
                                        <th class="border border-gray-200 px-3 py-2 text-left text-sm text-gray-700">Matric</th>
                                        <th class="border border-gray-200 px-3 py-2 text-left text-sm text-gray-700">Email</th>
                                        <th class="border border-gray-200 px-3 py-2 text-left text-sm text-gray-700">Department</th>
                                        <th class="border border-gray-200 px-3 py-2 text-left text-sm text-gray-700">Wallet</th>
                                        <th class="border border-gray-200 px-3 py-2 text-left text-sm text-gray-700">Verified</th>
                                        <th class="border border-gray-200 px-3 py-2 text-left text-sm text-gray-700">Last Vote</th>
                                        <th class="border border-gray-200 px-3 py-2 text-left text-sm text-gray-700">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="votersTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Modal -->
    <div id="loadingModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-2xl p-8 text-center">
            <div class="w-16 h-16 border-4 border-blue-200 border-t-blue-600 rounded-full animate-spin mx-auto mb-4"></div>
            <h3 class="text-lg font-bold text-gray-800 mb-2">Processing Vote</h3>
            <p class="text-gray-600">Confirming transaction on Solana blockchain...</p>
        </div>
    </div>

    <!-- Create Election Modal -->
    <div id="createElectionModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b border-gray-200">
                <div class="flex items-center justify-between">
                    <h2 class="text-2xl font-bold text-gray-800">Create New Election</h2>
                    <button onclick="closeCreateElectionModal()" class="text-gray-500 hover:text-gray-700">
                        <span class="text-2xl">√ó</span>
                    </button>
                </div>
            </div>
            
            <div class="p-6">
                <form id="createElectionForm" class="space-y-6">
                    <!-- Election Details -->
                    <div class="grid md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Election Title</label>
                            <input type="text" id="electionTitle" value="Student Union President Election 2024" 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Election Level</label>
                            <select id="electionLevel" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <option value="university">University Wide</option>
                                <option value="faculty">Faculty Level</option>
                                <option value="department">Department Level</option>
                            </select>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                        <textarea id="electionDescription" rows="3" 
                                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">Choose your preferred candidate for the next Student Union President. Your vote is secured on the Solana blockchain.</textarea>
                    </div>

                    <div class="grid md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Start Date & Time</label>
                            <input type="datetime-local" id="electionStartDate" 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">End Date & Time</label>
                            <input type="datetime-local" id="electionEndDate" 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                    </div>

                    <!-- Candidates Section -->
                    <div>
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-bold text-gray-800">Candidates</h3>
                            <button type="button" onclick="addCandidate()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm font-medium">
                                + Add Candidate
                            </button>
                        </div>
                        
                        <div id="candidatesContainer" class="space-y-6">
                            <!-- Candidate 1 -->
                            <div class="candidate-form bg-gray-50 rounded-lg p-4">
                                <div class="flex items-center justify-between mb-4">
                                    <h4 class="font-medium text-gray-800">Candidate 1</h4>
                                    <button type="button" onclick="removeCandidate(this)" class="text-red-600 hover:text-red-800 text-sm">Remove</button>
                                </div>
                                <div class="grid md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Full Name</label>
                                        <input type="text" name="candidateName" value="Alex Johnson" 
                                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Department</label>
                                        <input type="text" name="candidateDepartment" value="Computer Science" 
                                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Level</label>
                                        <select name="candidateLevel" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                            <option value="Final Year" selected>Final Year</option>
                                            <option value="Third Year">Third Year</option>
                                            <option value="Second Year">Second Year</option>
                                            <option value="First Year">First Year</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Avatar</label>
                                        <select name="candidateAvatar" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                            <option value="üë®‚Äçüéì" selected>üë®‚Äçüéì Male Graduate</option>
                                            <option value="üë©‚Äçüéì">üë©‚Äçüéì Female Graduate</option>
                                            <option value="üßë‚Äçüéì">üßë‚Äçüéì Graduate</option>
                                            <option value="üë®‚Äçüíº">üë®‚Äçüíº Male Professional</option>
                                            <option value="üë©‚Äçüíº">üë©‚Äçüíº Female Professional</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="mt-4">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Background Color</label>
                                    <select name="candidateColor" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                        <option value="blue" selected>Blue</option>
                                        <option value="purple">Purple</option>
                                        <option value="green">Green</option>
                                        <option value="red">Red</option>
                                        <option value="orange">Orange</option>
                                        <option value="indigo">Indigo</option>
                                    </select>
                                </div>
                            </div>

                            <!-- Candidate 2 -->
                            <div class="candidate-form bg-gray-50 rounded-lg p-4">
                                <div class="flex items-center justify-between mb-4">
                                    <h4 class="font-medium text-gray-800">Candidate 2</h4>
                                    <button type="button" onclick="removeCandidate(this)" class="text-red-600 hover:text-red-800 text-sm">Remove</button>
                                </div>
                                <div class="grid md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Full Name</label>
                                        <input type="text" name="candidateName" value="Sarah Williams" 
                                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Department</label>
                                        <input type="text" name="candidateDepartment" value="Business Admin" 
                                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Level</label>
                                        <select name="candidateLevel" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                            <option value="Final Year" selected>Final Year</option>
                                            <option value="Third Year">Third Year</option>
                                            <option value="Second Year">Second Year</option>
                                            <option value="First Year">First Year</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Avatar</label>
                                        <select name="candidateAvatar" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                            <option value="üë®‚Äçüéì">üë®‚Äçüéì Male Graduate</option>
                                            <option value="üë©‚Äçüéì" selected>üë©‚Äçüéì Female Graduate</option>
                                            <option value="üßë‚Äçüéì">üßë‚Äçüéì Graduate</option>
                                            <option value="üë®‚Äçüíº">üë®‚Äçüíº Male Professional</option>
                                            <option value="üë©‚Äçüíº">üë©‚Äçüíº Female Professional</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="mt-4">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Background Color</label>
                                    <select name="candidateColor" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                        <option value="blue">Blue</option>
                                        <option value="purple" selected>Purple</option>
                                        <option value="green">Green</option>
                                        <option value="red">Red</option>
                                        <option value="orange">Orange</option>
                                        <option value="indigo">Indigo</option>
                                    </select>
                                </div>
                            </div>

                            <!-- Candidate 3 -->
                            <div class="candidate-form bg-gray-50 rounded-lg p-4">
                                <div class="flex items-center justify-between mb-4">
                                    <h4 class="font-medium text-gray-800">Candidate 3</h4>
                                    <button type="button" onclick="removeCandidate(this)" class="text-red-600 hover:text-red-800 text-sm">Remove</button>
                                </div>
                                <div class="grid md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Full Name</label>
                                        <input type="text" name="candidateName" value="Michael Chen" 
                                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Department</label>
                                        <input type="text" name="candidateDepartment" value="Engineering" 
                                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Level</label>
                                        <select name="candidateLevel" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                            <option value="Final Year" selected>Final Year</option>
                                            <option value="Third Year">Third Year</option>
                                            <option value="Second Year">Second Year</option>
                                            <option value="First Year">First Year</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Avatar</label>
                                        <select name="candidateAvatar" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                            <option value="üë®‚Äçüéì" selected>üë®‚Äçüéì Male Graduate</option>
                                            <option value="üë©‚Äçüéì">üë©‚Äçüéì Female Graduate</option>
                                            <option value="üßë‚Äçüéì">üßë‚Äçüéì Graduate</option>
                                            <option value="üë®‚Äçüíº">üë®‚Äçüíº Male Professional</option>
                                            <option value="üë©‚Äçüíº">üë©‚Äçüíº Female Professional</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="mt-4">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Background Color</label>
                                    <select name="candidateColor" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                        <option value="blue">Blue</option>
                                        <option value="purple">Purple</option>
                                        <option value="green" selected>Green</option>
                                        <option value="red">Red</option>
                                        <option value="orange">Orange</option>
                                        <option value="indigo">Indigo</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Form Actions -->
                    <div class="flex justify-end space-x-4 pt-6 border-t border-gray-200">
                        <button type="button" onclick="closeCreateElectionModal()" 
                                class="px-6 py-3 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 font-medium">
                            Cancel
                        </button>
                        <button type="submit" 
                                class="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium">
                            Create Election
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Add/Edit Voter Modal -->
    <div id="voterModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl max-w-lg w-full">
            <div class="p-5 border-b border-gray-200 flex items-center justify-between">
                <h2 class="text-xl font-bold text-gray-800" id="voterModalTitle">Add Voter</h2>
                <button onclick="closeVoterModal()" class="text-gray-500 hover:text-gray-700"><span class="text-2xl">√ó</span></button>
            </div>
            <div class="p-6">
                <form id="voterForm" class="space-y-4">
                    <input type="hidden" id="voterId" />
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Full Name</label>
                        <input id="vName" class="w-full px-3 py-2 border border-gray-300 rounded-lg" />
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Matric</label>
                            <input id="vMatric" class="w-full px-3 py-2 border border-gray-300 rounded-lg" />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                            <input id="vEmail" type="email" class="w-full px-3 py-2 border border-gray-300 rounded-lg" />
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Department</label>
                            <input id="vDept" class="w-full px-3 py-2 border border-gray-300 rounded-lg" />
                        </div>
                        
                    </div>
                    <div class="flex items-center justify-between">
                        <label class="inline-flex items-center space-x-2">
                            <input id="vEligible" type="checkbox" class="h-4 w-4" checked />
                            <span class="text-sm text-gray-700">Eligible to vote</span>
                        </label>
                        <label class="inline-flex items-center space-x-2">
                            <input id="vVerified" type="checkbox" class="h-4 w-4" />
                            <span class="text-sm text-gray-700">Wallet verified</span>
                        </label>
                    </div>
                    <div class="flex justify-end space-x-3 pt-4">
                        <button type="button" onclick="closeVoterModal()" class="px-4 py-2 border border-gray-300 rounded-lg">Cancel</button>
                        <button type="submit" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg">Save</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Local Storage Management
        class LocalStorageManager {
            static init() {
                // Initialize default data if not exists
                if (!localStorage.getItem('macvotes_students')) {
                    const defaultStudents = [
                        { matric: 'DE.2021/4311', name: 'John Doe', email: 'john@university.edu', department: 'Computer Science' },
                        { matric: 'DE.2021/4312', name: 'Jane Smith', email: 'jane@university.edu', department: 'Business Admin' },
                        { matric: 'DE.2021/4313', name: 'Bob Wilson', email: 'bob@university.edu', department: 'Engineering' },
                        { matric: 'DE.2021/0001', name: 'Admin User', email: 'admin@university.edu', department: 'Administration', isAdmin: true }
                    ];
                    localStorage.setItem('macvotes_students', JSON.stringify(defaultStudents));
                }

                if (!localStorage.getItem('macvotes_elections')) {
                    const defaultElections = [
                        { 
                            id: 1, 
                            title: 'Student Union President Election 2024', 
                            description: 'Choose your preferred candidate for the next Student Union President. Your vote is secured on the Solana blockchain.',
                            level: 'university',
                            status: 'active', 
                            totalVotes: 56,
                            startDate: new Date().toISOString(),
                            endDate: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString(),
                            candidates: [
                                { id: 1, name: 'Alex Johnson', department: 'Computer Science', level: 'Final Year', avatar: 'üë®‚Äçüéì', color: 'blue', votes: 15 },
                                { id: 2, name: 'Sarah Williams', department: 'Business Admin', level: 'Final Year', avatar: 'üë©‚Äçüéì', color: 'purple', votes: 23 },
                                { id: 3, name: 'Michael Chen', department: 'Engineering', level: 'Final Year', avatar: 'üë®‚Äçüéì', color: 'green', votes: 18 }
                            ]
                        }
                    ];
                    localStorage.setItem('macvotes_elections', JSON.stringify(defaultElections));
                }

                if (!localStorage.getItem('macvotes_votes')) {
                    localStorage.setItem('macvotes_votes', JSON.stringify([]));
                }
            }

            static getStudents() {
                return JSON.parse(localStorage.getItem('macvotes_students') || '[]');
            }

            static getElections() {
                return JSON.parse(localStorage.getItem('macvotes_elections') || '[]');
            }

            static getVotes() {
                return JSON.parse(localStorage.getItem('macvotes_votes') || '[]');
            }

            static saveElections(elections) {
                localStorage.setItem('macvotes_elections', JSON.stringify(elections));
            }

            static saveVotes(votes) {
                localStorage.setItem('macvotes_votes', JSON.stringify(votes));
            }

            static addVote(vote) {
                const votes = this.getVotes();
                votes.push(vote);
                this.saveVotes(votes);
            }

            static hasUserVoted(matric, electionId) {
                const votes = this.getVotes();
                return votes.some(vote => vote.matric === matric && vote.electionId === electionId);
            }
        }

        // Initialize local storage
        LocalStorageManager.init();

        // Load data from local storage
        const students = LocalStorageManager.getStudents();
        let currentUser = null;
        let walletConnected = false;
        let hasVoted = false;
        let isAdminAuthenticated = false;
        let elections = LocalStorageManager.getElections();
        let currentElection = elections.find(e => e.status === 'active') || null;

        // Initialize displays
        updateVoteDisplay();
        updateVotingInterface();

        // Matric number validation (via API)
        document.getElementById('matricInput').addEventListener('input', async function(e) {
            const matric = e.target.value.trim();
            const statusDiv = document.getElementById('matricStatus');
            const connectBtn = document.getElementById('connectWalletBtn');
            
            if (matric.length < 3) {
                statusDiv.className = 'mt-2 text-sm hidden';
                connectBtn.disabled = true;
                connectBtn.className = 'w-full bg-gray-300 text-gray-500 py-3 rounded-lg font-medium cursor-not-allowed transition-all';
                connectBtn.textContent = 'üîí Verify Matric First';
                return;
            }

            try {
                const resp = await fetch(`http://localhost:8080/api/voters/verify/${encodeURIComponent(matric)}`);
                const json = await resp.json();
                if (json?.ok) {
                    currentUser = { name: json.voter.name, matric: json.voter.matric, department: json.voter.department || '‚Äî' };
                statusDiv.className = 'mt-2 text-sm text-green-600';
                statusDiv.innerHTML = `‚úÖ Verified: ${currentUser.name} (${currentUser.department})`;
                connectBtn.disabled = false;
                connectBtn.className = 'w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg font-medium transition-all';
                connectBtn.textContent = 'üîó Connect Solana Wallet';
                } else {
                statusDiv.className = 'mt-2 text-sm text-red-600';
                statusDiv.innerHTML = '‚ùå Matriculation number not found';
                connectBtn.disabled = true;
                connectBtn.className = 'w-full bg-gray-300 text-gray-500 py-3 rounded-lg font-medium cursor-not-allowed transition-all';
                connectBtn.textContent = 'üîí Invalid Matric Number';
                }
            } catch {
                statusDiv.className = 'mt-2 text-sm text-red-600';
                statusDiv.innerHTML = '‚ùå Unable to verify matric right now';
                connectBtn.disabled = true;
                connectBtn.className = 'w-full bg-gray-300 text-gray-500 py-3 rounded-lg font-medium cursor-not-allowed transition-all';
                connectBtn.textContent = 'üîí Invalid Matric Number';
            }
        });

        async function linkWalletOrBlock(walletAddress) {
            if (!currentUser?.matric) {
                alert('Verify matric first');
                return false;
            }
            try {
                const resp = await fetch('http://localhost:8080/api/voters/wallet', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ matric: currentUser.matric, walletAddress })
                });
                if (resp.ok) return true;
                if (resp.status === 409) {
                    const j = await resp.json().catch(()=>({error:'Wallet already linked'}));
                    alert(j.error || 'Wallet already linked to another matric');
                    return false;
                }
                alert('Unable to link wallet. Please try again.');
                return false;
            } catch {
                alert('Unable to link wallet right now.');
                return false;
            }
        }

        // REAL Wallet connection - Simplified version
        document.getElementById('connectWalletBtn').addEventListener('click', async function() {
            if (!currentUser) return;
            
            try {
                console.log('üîÑ Attempting wallet connection...');
                
                // Use our detection function
                const provider = window.detectWallet();
                
                if (!provider) {
                    console.log('‚ùå No wallet provider found');
                    alert('Phantom wallet not detected! Please:\n\n1. Install Phantom browser extension\n2. Unlock your Phantom wallet\n3. Refresh this page\n4. Try again');
                    window.open('https://phantom.app/', '_blank');
                    return;
                }
                
                console.log('‚úÖ Wallet provider found:', provider);
                
                // Check if already connected
                if (provider.isConnected) {
                    console.log('‚úÖ Wallet already connected');
                    const walletAddress = provider.publicKey.toString();
                
                document.getElementById('walletInfo').classList.remove('hidden');
                document.getElementById('walletAddress').textContent = walletAddress;
                
                walletConnected = true;
                    window.walletProvider = provider;
                    const ok = await linkWalletOrBlock(walletAddress);
                    if (!ok) return;
                    document.getElementById('loginSection').classList.add('hidden');
                    document.getElementById('votingSection').classList.remove('hidden');
                    updateVotingInterface();
                    return;
                }
                
                // Request connection
                console.log('üîÑ Requesting wallet connection...');
                const response = await provider.connect();
                const walletAddress = response.publicKey.toString();
                
                document.getElementById('walletInfo').classList.remove('hidden');
                document.getElementById('walletAddress').textContent = walletAddress;
                
                walletConnected = true;
                window.walletProvider = provider;
                
                // Check if user has already voted (server-side)
                hasVoted = false;
                try {
                    if (currentElection) {
                        const hv = await (await fetch(`http://localhost:8080/api/votes/hasVoted?electionId=${currentElection.id}&matric=${encodeURIComponent(currentUser.matric)}`)).json();
                        hasVoted = !!hv?.hasVoted;
                    }
                } catch {}
                
                console.log('‚úÖ Wallet connected:', walletAddress);
                
                const ok = await linkWalletOrBlock(walletAddress);
                if (!ok) return;
                setTimeout(() => {
                    document.getElementById('loginSection').classList.add('hidden');
                    document.getElementById('votingSection').classList.remove('hidden');
                    updateVotingInterface();
                }, 200);
                
            } catch (error) {
                console.error('Wallet connection failed:', error);
                if (error.code === 4001) {
                    alert('Connection cancelled by user');
                } else if (error.message) {
                    alert(`Failed to connect wallet: ${error.message}`);
                } else {
                    alert('Failed to connect wallet. Please make sure Phantom is unlocked and try again.');
                }
            }
        });

        // Vote casting function - REAL BLOCKCHAIN VERSION
        async function castVote(candidateId, candidateName) {
            if (!walletConnected || !window.walletProvider) {
                alert('Please connect your wallet first');
                return;
            }
            
            if (!currentElection) {
                alert('No active election found');
                return;
            }
            
            if (hasVoted || LocalStorageManager.hasUserVoted(currentUser.matric, currentElection.id)) {
                alert('You have already voted in this election');
                return;
            }

            // Show loading modal
            document.getElementById('loadingModal').classList.remove('hidden');
            
            try {
                // REAL BLOCKCHAIN TRANSACTION
                const connection = new solanaWeb3.Connection(
                    'https://api.devnet.solana.com', // Use devnet for testing
                    'confirmed'
                );
                
                // Get wallet public key
                const walletPublicKey = window.walletProvider.publicKey;
                
                // Create vote transaction with memo
                const voteData = {
                    election: currentElection.id,
                    candidate: candidateId,
                    candidateName: candidateName,
                    voter: currentUser.matric,
                    timestamp: Date.now()
                };
                
                // Create transaction with memo (vote data stored on-chain)
                const transaction = new solanaWeb3.Transaction();
                
                // Add memo instruction with vote data (TextEncoder for browser)
                const memoBytes = new TextEncoder().encode(JSON.stringify(voteData));
                transaction.add(
                    new solanaWeb3.TransactionInstruction({
                        keys: [],
                        programId: new solanaWeb3.PublicKey('MemoSq4gqABAXKb96qnH8TysNcWxMyWCqXgDLGmfcHr'),
                        data: memoBytes
                    })
                );
                
                // Get recent blockhash
                const { blockhash, lastValidBlockHeight } = await connection.getLatestBlockhash('finalized');
                transaction.recentBlockhash = blockhash;
                transaction.feePayer = walletPublicKey;
                
                // Sign and send via wallet (handles submission reliably)
                const sendResult = await window.walletProvider.signAndSendTransaction(transaction);
                const signature = sendResult?.signature || sendResult; // support both shapes
                
                // Wait for confirmation with blockhash context
                await connection.confirmTransaction({ signature, blockhash, lastValidBlockHeight }, 'confirmed');
                
                // Save vote record with REAL transaction signature (local cache)
                const voteRecord = {
                    id: Date.now(),
                    electionId: currentElection.id,
                    candidateId: candidateId,
                    candidateName: candidateName,
                    voterName: currentUser.name,
                    matric: currentUser.matric,
                    walletAddress: walletPublicKey.toString(),
                    transactionId: signature, // REAL BLOCKCHAIN SIGNATURE
                    timestamp: new Date().toISOString(),
                    network: 'devnet'
                };
                
                LocalStorageManager.addVote(voteRecord);
                
                // Optimistic update
                const votedCandidate = currentElection.candidates.find(c => c.id === candidateId);
                if (votedCandidate) {
                    votedCandidate.votes = (votedCandidate.votes || 0) + 1;
                }
                currentElection.totalVotes = (currentElection.totalVotes || 0) + 1;
                updateVoteDisplay();

                // Persist current election snapshot locally so later UI refreshes don't revert
                try {
                elections = LocalStorageManager.getElections();
                    const idx = elections.findIndex(e => e.id === currentElection.id);
                    if (idx !== -1) {
                        elections[idx] = currentElection;
                    } else {
                        elections.push(currentElection);
                    }
                    LocalStorageManager.saveElections(elections);
                } catch {}

                // Refresh counts from API (authoritative)
                try {
                    await new Promise(r => setTimeout(r, 500));
                    const resp = await fetch(`http://localhost:8080/api/stats/${currentElection.id}`);
                    const stats = await resp.json();
                    if (Array.isArray(stats)) {
                        currentElection.candidates.forEach(c => {
                            const row = stats.find((s) => s.candidateId === c.id);
                            if (row) c.votes = row.votes;
                        });
                        currentElection.totalVotes = stats.reduce((a, b) => a + (b.votes || 0), 0);
                updateVoteDisplay();
                        // Persist refreshed counts locally
                        try {
                            elections = LocalStorageManager.getElections();
                            const idx = elections.findIndex(e => e.id === currentElection.id);
                            if (idx !== -1) {
                                elections[idx] = currentElection;
                            } else {
                                elections.push(currentElection);
                            }
                            LocalStorageManager.saveElections(elections);
                        } catch {}
                    }
                } catch (err) {
                    console.warn('Failed to refresh stats from API:', err);
                }
                
                // Persist to backend API
                try {
                    await fetch('http://localhost:8080/api/votes', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            signature,
                            electionId: currentElection.id,
                            candidateId,
                            candidateName,
                            matric: currentUser.matric,
                            walletAddress: walletPublicKey.toString(),
                            network: 'devnet'
                        })
                    });
                } catch (e) {
                    console.warn('Failed to persist vote to API (continuing):', e);
                }

                // Show confirmation with REAL transaction
                document.getElementById('votedCandidate').textContent = candidateName;
                document.getElementById('transactionId').textContent = signature;
                document.getElementById('voteTimestamp').textContent = new Date().toLocaleString();
                
                document.getElementById('loadingModal').classList.add('hidden');
                document.getElementById('voteConfirmation').classList.remove('hidden');
                
                hasVoted = true;
                // Avoid full UI reload to prevent counts from reverting to stale storage
                disableVoteButtons();
                updateVoteDisplay();
                
                console.log('‚úÖ Vote recorded on Solana blockchain:', `https://explorer.solana.com/tx/${signature}?cluster=devnet`);
                
            } catch (error) {
                console.error('Blockchain transaction failed:', error);
                document.getElementById('loadingModal').classList.add('hidden');
                alert(`Failed to cast vote on blockchain: ${error.message}`);
            }
        }

        // Update vote display
        function updateVoteDisplay() {
            if (!currentElection || !currentElection.candidates) return;
            
            currentElection.candidates.forEach((candidate, index) => {
                const voteElement = document.getElementById(`votes-${candidate.id}`);
                if (voteElement) {
                    voteElement.textContent = candidate.votes || 0;
                }
            });
            
            const totalVotesElement = document.getElementById('totalVotes');
            if (totalVotesElement) {
                totalVotesElement.textContent = `üìä Total Votes: ${currentElection.totalVotes || 0}`;
            }
        }

        // Update voting interface based on current election
        async function updateVotingInterface() {
            const votingSection = document.getElementById('votingSection');
            const noElectionsMessage = document.getElementById('noElectionsMessage');
            const activeElectionContent = document.getElementById('activeElectionContent');
            
            // Always fetch active elections from API and render cards
            try {
                const list = await (await fetch('http://localhost:8080/api/elections')).json();
                const container = document.getElementById('electionCards');
                container.innerHTML = '';
                if (Array.isArray(list) && list.length) {
                    list.forEach((el) => {
                        const card = document.createElement('div');
                        card.className = 'bg-white rounded-2xl card-shadow p-5 hover:shadow-lg transition cursor-pointer';
                        card.innerHTML = `
                            <div class="h-28 bg-gradient-to-br from-indigo-400 to-indigo-600 rounded-xl mb-4 flex items-center justify-center text-white text-3xl">üó≥Ô∏è</div>
                            <div class="flex items-start justify-between">
                                <div>
                                    <div class="text-sm text-gray-500">${el.level}</div>
                                    <div class="text-lg font-semibold text-gray-800">${el.title}</div>
                                </div>
                                <div class="text-xs text-gray-500">Ends ${new Date(el.endDate).toLocaleString()}</div>
                            </div>
                            <p class="mt-2 text-gray-600 line-clamp-2">${el.description}</p>
                        `;
                        card.onclick = async () => {
                            const detail = await (await fetch(`http://localhost:8080/api/elections/${el.id}`)).json();
                            currentElection = { id: detail.id, title: detail.title, description: detail.description, candidates: detail.candidates.map((c)=>({ id: c.id, name: c.name, department: c.department, level: c.level, avatar: c.avatar, color: c.color, votes: 0 })) };
                            document.getElementById('detailTitle').textContent = detail.title;
                            document.getElementById('detailMeta').textContent = `${detail.level} ‚Ä¢ Ends ${new Date(detail.endDate).toLocaleString()}`;
                            document.getElementById('detailDesc').textContent = detail.description;
                            document.getElementById('electionDetail').classList.remove('hidden');
                            document.getElementById('candidatesGrid').classList.remove('hidden');
                            updateCandidatesGrid();
                            updateVoteDisplay();
                            // refresh counts
                            try {
                                const stats = await (await fetch(`http://localhost:8080/api/stats/${detail.id}`)).json();
                                if (Array.isArray(stats)) {
                                    currentElection.candidates.forEach(c => { const row = stats.find(s=>s.candidateId===c.id); if (row) c.votes = row.votes; });
                                    currentElection.totalVotes = stats.reduce((a,b)=>a+(b.votes||0),0);
                                    updateVoteDisplay();
                                }
                            } catch {}
                        };
                        container.appendChild(card);
                    });
                } else {
                    container.innerHTML = '<div class="text-gray-500 text-center py-8">No active elections</div>';
                }
            } catch {}
            
            if (!currentElection) {
                if (noElectionsMessage) noElectionsMessage.classList.remove('hidden');
                if (activeElectionContent) activeElectionContent.classList.add('hidden');
                // Clear candidates grid when no election exists
                const candidatesContainer = document.querySelector('.grid.md\\:grid-cols-2.lg\\:grid-cols-3.gap-6.mb-8');
                if (candidatesContainer) {
                    candidatesContainer.innerHTML = '';
                }
                return;
            }
            
            if (noElectionsMessage) noElectionsMessage.classList.add('hidden');
            if (activeElectionContent) activeElectionContent.classList.remove('hidden');
            
            // Update election title and description
            const titleElement = document.querySelector('#activeElectionContent h3');
            const descElement = document.querySelector('#activeElectionContent p');
            if (titleElement) titleElement.textContent = currentElection.title;
            if (descElement) descElement.textContent = currentElection.description;
            
            // Pull latest active election from API to update candidates
            try {
                const resp = await fetch('http://localhost:8080/api/elections/active');
                if (resp.ok) {
                    const active = await resp.json();
                    if (active && active.id) {
                        currentElection = {
                            id: active.id,
                            title: active.title,
                            description: active.description,
                            candidates: active.candidates.map((c) => ({ id: c.id, name: c.name, department: c.department, level: c.level, avatar: c.avatar, color: c.color, votes: 0 })),
                            status: 'active'
                        };
                    }
                }
            } catch {}
            // Update candidates grid for current election if any selected
            updateCandidatesGrid();
            updateVoteDisplay();
            
            // Update vote buttons state
            if (currentUser && hasVoted) {
                disableVoteButtons();
            }
        }

        // Update candidates grid dynamically
        function updateCandidatesGrid() {
            if (!currentElection || !currentElection.candidates) return;
            
            const candidatesContainer = document.getElementById('candidatesGrid');
            if (!candidatesContainer) return;
            
            candidatesContainer.innerHTML = '';
            
            currentElection.candidates.forEach(candidate => {
                const candidateCard = createCandidateCard(candidate);
                candidatesContainer.appendChild(candidateCard);
            });
        }

        // Create candidate card element
        function createCandidateCard(candidate) {
            const card = document.createElement('div');
            card.className = 'bg-white rounded-2xl card-shadow overflow-hidden';
            
            const colorClasses = {
                blue: 'from-blue-400 to-blue-600',
                purple: 'from-purple-400 to-purple-600',
                green: 'from-green-400 to-green-600',
                red: 'from-red-400 to-red-600',
                orange: 'from-orange-400 to-orange-600',
                indigo: 'from-indigo-400 to-indigo-600'
            };
            
            const buttonColorClasses = {
                blue: 'bg-blue-600 hover:bg-blue-700',
                purple: 'bg-purple-600 hover:bg-purple-700',
                green: 'bg-green-600 hover:bg-green-700',
                red: 'bg-red-600 hover:bg-red-700',
                orange: 'bg-orange-600 hover:bg-orange-700',
                indigo: 'bg-indigo-600 hover:bg-indigo-700'
            };
            
            const voteCountColorClasses = {
                blue: 'text-blue-600',
                purple: 'text-purple-600',
                green: 'text-green-600',
                red: 'text-red-600',
                orange: 'text-orange-600',
                indigo: 'text-indigo-600'
            };
            
            card.innerHTML = `
                <div class="h-48 bg-gradient-to-br ${colorClasses[candidate.color] || colorClasses.blue} flex items-center justify-center">
                    <span class="text-6xl text-white">${candidate.avatar || 'üë®‚Äçüéì'}</span>
                </div>
                <div class="p-6">
                    <h4 class="text-lg font-bold text-gray-800 mb-2">${candidate.name}</h4>
                    <p class="text-gray-600 text-sm mb-4">${candidate.department} ‚Ä¢ ${candidate.level}</p>
                    <div class="flex items-center justify-between mb-4">
                        <span class="text-2xl font-bold ${voteCountColorClasses[candidate.color] || voteCountColorClasses.blue}" id="votes-${candidate.id}">${candidate.votes || 0}</span>
                        <span class="text-sm text-gray-500">votes</span>
                    </div>
                    <button onclick="castVote(${candidate.id}, '${candidate.name}')" 
                            class="vote-button w-full ${buttonColorClasses[candidate.color] || buttonColorClasses.blue} text-white py-3 rounded-lg font-medium transition-all">
                        Vote for ${candidate.name.split(' ')[0]}
                    </button>
                </div>
            `;
            
            return card;
        }

        // Disable vote buttons after voting
        function disableVoteButtons() {
            const voteButtons = document.querySelectorAll('.vote-button');
            voteButtons.forEach(btn => {
                btn.disabled = true;
                btn.className = btn.className.replace(/bg-\w+-600 hover:bg-\w+-700/g, 'bg-gray-300');
                btn.textContent = 'Vote Cast';
            });
        }

        // Admin panel functions
        document.getElementById('adminBtn').addEventListener('click', async function() {
            try {
                // Require wallet connection
                const provider = window.detectWallet();
                if (!provider) {
                    alert('Connect Phantom wallet first.');
                    return;
                }
                // Request nonce
                const address = provider.publicKey?.toString() || (await provider.connect()).publicKey.toString();
                const nonceRes = await fetch('http://localhost:8080/auth/nonce', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ address })
                });
                const { nonce } = await nonceRes.json();
                const message = new TextEncoder().encode(`Sign in to Mac Votes: ${nonce}`);
                // Some providers require .signMessage({ message }) or different encodings; try both
                let signed;
                try {
                    signed = await provider.signMessage(message, 'utf8');
                } catch {
                    signed = await provider.signMessage(message);
                }
                const signatureBase58 = (window.bs58 ? window.bs58.encode(signed.signature) : null);
                // If bs58 not present on page, send raw Uint8Array as array
                const verifyBody = signatureBase58 ? { address, signature: signatureBase58, nonce } : { address, signature: Array.from(new Uint8Array(signed.signature || signed)), nonce };
                const verifyRes = await fetch('http://localhost:8080/auth/verify', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(verifyBody)
                });
                if (!verifyRes.ok) {
                    const e = await verifyRes.json().catch(()=>({error:'Auth failed'}));
                    alert('Admin sign-in failed: ' + (e.error || verifyRes.status));
                    return;
                }
                // fetch role
                let role = 'VIEWER';
                try {
                    const who = await fetch('http://localhost:8080/admin/elections', { credentials:'include' });
                    if (who.ok) role = 'ADMIN';
                } catch {}
                if (role !== 'ADMIN') {
                    alert('You are not authorized to access the admin panel.');
                    return;
                }
                isAdminAuthenticated = true;
                showAdminPanel();
            } catch (e) {
                alert('Admin sign-in cancelled/failed');
            }
        });

        function showAdminPanel() {
            document.getElementById('adminPanel').classList.remove('hidden');
            document.getElementById('loginSection').classList.add('hidden');
            document.getElementById('votingSection').classList.add('hidden');
            refreshAdminData();
            updateElectionTable();
        }

        function refreshAdminData() {
            fetch('http://localhost:8080/admin/elections', { credentials: 'include' })
                .then(r=>r.json()).then(async (apiElections)=>{
                    let totalVotes = 0;
                    for (const el of apiElections) {
                        try {
                            const s = await fetch(`http://localhost:8080/api/stats/${el.id}`);
                            const stats = await s.json();
                            totalVotes += Array.isArray(stats) ? stats.reduce((a,b)=>a+(b.votes||0),0) : 0;
                        } catch {}
                    }
                    // Fetch registered voters count from API
                    let totalStudents = 0;
                    try {
                        const v = await fetch('http://localhost:8080/api/voters', { credentials: 'include' });
                        const arr = await v.json();
                        totalStudents = Array.isArray(arr) ? arr.length : 0;
                    } catch {}
                    const activeElections = apiElections.filter((e)=>e.status==='ACTIVE').length;
                    const participationRate = totalStudents>0?Math.round((totalVotes/totalStudents)*100):0;
                    document.querySelector('.bg-blue-50 .text-2xl').textContent = totalVotes;
                    document.getElementById('registeredCount').textContent = totalStudents;
                    document.querySelector('.bg-purple-50 .text-2xl').textContent = activeElections;
                    document.querySelector('.bg-orange-50 .text-2xl').textContent = `${participationRate}%`;
                }).catch(()=>{});
        }

        document.getElementById('closeAdminBtn').addEventListener('click', function() {
            document.getElementById('adminPanel').classList.add('hidden');
            document.getElementById('loginSection').classList.remove('hidden');
        });

        function createElection() {
            // Set default dates
            const now = new Date();
            const tomorrow = new Date(now);
            tomorrow.setDate(tomorrow.getDate() + 1);
            
            document.getElementById('electionStartDate').value = now.toISOString().slice(0, 16);
            document.getElementById('electionEndDate').value = tomorrow.toISOString().slice(0, 16);
            
            // Show modal
            document.getElementById('createElectionModal').classList.remove('hidden');
        }

        function closeCreateElectionModal() {
            document.getElementById('createElectionModal').classList.add('hidden');
        }

        function addCandidate() {
            const container = document.getElementById('candidatesContainer');
            const candidateCount = container.children.length + 1;
            
            const candidateForm = document.createElement('div');
            candidateForm.className = 'candidate-form bg-gray-50 rounded-lg p-4';
            candidateForm.innerHTML = `
                <div class="flex items-center justify-between mb-4">
                    <h4 class="font-medium text-gray-800">Candidate ${candidateCount}</h4>
                    <button type="button" onclick="removeCandidate(this)" class="text-red-600 hover:text-red-800 text-sm">Remove</button>
                </div>
                <div class="grid md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Full Name</label>
                        <input type="text" name="candidateName" value="" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Department</label>
                        <input type="text" name="candidateDepartment" value="" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Level</label>
                        <select name="candidateLevel" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="Final Year">Final Year</option>
                            <option value="Third Year">Third Year</option>
                            <option value="Second Year">Second Year</option>
                            <option value="First Year">First Year</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Avatar</label>
                        <select name="candidateAvatar" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="üë®‚Äçüéì">üë®‚Äçüéì Male Graduate</option>
                            <option value="üë©‚Äçüéì">üë©‚Äçüéì Female Graduate</option>
                            <option value="üßë‚Äçüéì">üßë‚Äçüéì Graduate</option>
                            <option value="üë®‚Äçüíº">üë®‚Äçüíº Male Professional</option>
                            <option value="üë©‚Äçüíº">üë©‚Äçüíº Female Professional</option>
                        </select>
                    </div>
                </div>
                <div class="mt-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Background Color</label>
                    <select name="candidateColor" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="blue">Blue</option>
                        <option value="purple">Purple</option>
                        <option value="green">Green</option>
                        <option value="red">Red</option>
                        <option value="orange">Orange</option>
                        <option value="indigo">Indigo</option>
                    </select>
                </div>
            `;
            
            container.appendChild(candidateForm);
        }

        function removeCandidate(button) {
            const candidateForm = button.closest('.candidate-form');
            const container = document.getElementById('candidatesContainer');
            
            if (container.children.length > 2) {
                candidateForm.remove();
                // Update candidate numbers
                Array.from(container.children).forEach((form, index) => {
                    const header = form.querySelector('h4');
                    header.textContent = `Candidate ${index + 1}`;
                });
            } else {
                alert('You must have at least 2 candidates');
            }
        }

        // Handle form submission
        document.getElementById('createElectionForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const title = document.getElementById('electionTitle').value;
            const description = document.getElementById('electionDescription').value;
            const level = document.getElementById('electionLevel').value.toUpperCase();
            const startDate = document.getElementById('electionStartDate').value;
            const endDate = document.getElementById('electionEndDate').value;
            
            // Collect candidate data
            const candidateForms = document.querySelectorAll('.candidate-form');
            const candidates = [];
            
            candidateForms.forEach((form, index) => {
                const name = form.querySelector('input[name="candidateName"]').value;
                const department = form.querySelector('input[name="candidateDepartment"]').value;
                const candidateLevel = form.querySelector('select[name="candidateLevel"]').value;
                const avatar = form.querySelector('select[name="candidateAvatar"]').value;
                const color = form.querySelector('select[name="candidateColor"]').value;
                
                if (name && department) {
                    candidates.push({
                        id: index + 1,
                        name: name,
                        department: department,
                        level: candidateLevel,
                        avatar: avatar,
                        color: color,
                        votes: 0
                    });
                }
            });
            
            if (candidates.length < 2) {
                alert('Please add at least 2 candidates with names and departments');
                return;
            }
            
            try {
                const resp = await fetch('http://localhost:8080/admin/elections', {
                    method: 'POST', credentials: 'include', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title, description, level, startDate, endDate, candidates })
                });
                if (!resp.ok) throw new Error('Failed');
                closeCreateElectionModal();
                await updateElectionTable();
                await refreshAdminData();
                alert('Election created successfully!');
            } catch {
                alert('Failed to create election via API');
            }
        });

        function downloadCSV() {
            const votes = LocalStorageManager.getVotes();
            
            if (votes.length === 0) {
                alert('No votes to export');
                return;
            }
            
            let csvContent = "Election ID,Election Title,Candidate,Voter Name,Matric Number,Wallet Address,Transaction ID,Timestamp\n";
            
            votes.forEach(vote => {
                const election = elections.find(e => e.id === vote.electionId);
                const electionTitle = election ? election.title : 'Unknown Election';
                
                csvContent += `${vote.electionId},"${electionTitle}","${vote.candidateName}","${vote.voterName}",${vote.matric},${vote.walletAddress},${vote.transactionId},${new Date(vote.timestamp).toLocaleString()}\n`;
            });
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `election_results_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        function verifyWinner() {
            if (!currentElection || !currentElection.candidates || currentElection.candidates.length === 0) {
                alert('No active election found');
                return;
            }
            
            const candidates = currentElection.candidates;
            const maxVotes = Math.max(...candidates.map(c => c.votes || 0));
            const winner = candidates.find(c => (c.votes || 0) === maxVotes);
            
            if (!winner || maxVotes === 0) {
                alert('No votes have been cast yet');
                return;
            }
            
            const winnersCount = candidates.filter(c => (c.votes || 0) === maxVotes).length;
            
            if (winnersCount > 1) {
                alert(`There is a tie! Multiple candidates have ${maxVotes} votes each.`);
            } else {
                alert(`Winner verified: ${winner.name} with ${maxVotes} votes. Results have been locked on the blockchain.`);
            }
        }

        function updateElectionTable() {
            const tbody = document.getElementById('electionTableBody');
            tbody.innerHTML = '';
            
            fetch('http://localhost:8080/admin/elections', { credentials: 'include' })
                .then(r=>r.json()).then(async (apiElections)=>{
                    if (!Array.isArray(apiElections) || apiElections.length===0) {
                        tbody.innerHTML = '<tr><td colspan="4" class="border border-gray-200 px-4 py-3 text-center text-gray-500">No elections available</td></tr>';
                        return;
                    }
                    for (const election of apiElections) {
                        let totalVotes = 0;
                        try {
                            const s = await fetch(`http://localhost:8080/api/stats/${election.id}`);
                            const stats = await s.json();
                            totalVotes = Array.isArray(stats) ? stats.reduce((a,b)=>a+(b.votes||0),0) : 0;
                        } catch {}
                        const statusColor = election.status === 'ACTIVE' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800';
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td class="border border-gray-200 px-4 py-3">${election.title}</td>
                            <td class="border border-gray-200 px-4 py-3">
                                <span class="${statusColor} px-2 py-1 rounded-full text-xs">${election.status}</span>
                            </td>
                            <td class="border border-gray-200 px-4 py-3">${totalVotes}</td>
                            <td class="border border-gray-200 px-4 py-3 space-x-2">
                                <button onclick="completeElection(${election.id})" class="text-orange-600 hover:text-orange-800 text-sm">Complete</button>
                            </td>
                        `;
                        tbody.appendChild(row);
                    }
                }).catch(()=>{
                    tbody.innerHTML = '<tr><td colspan="4" class="border border-gray-200 px-4 py-3 text-center text-red-500">Failed to load elections</td></tr>';
                });
        }

        // Voters UI logic
        async function refreshVoters() {
            const tbody = document.getElementById('votersTableBody');
            if (!tbody) return;
            tbody.innerHTML = '';
            try {
                const resp = await fetch('http://localhost:8080/api/voters', { credentials: 'include' });
                const voters = await resp.json();
                const q = (document.getElementById('voterSearch')?.value || '').toLowerCase();
                voters
                  .filter(v => !q || [v.name, v.matric, v.email].some(x => (x||'').toLowerCase().includes(q)))
                  .slice(0, 200)
                  .forEach(v => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                      <td class="border px-3 py-2">${v.name}</td>
                      <td class="border px-3 py-2 font-mono">${v.matric}</td>
                      <td class="border px-3 py-2">${v.email || ''}</td>
                      <td class="border px-3 py-2">${v.department || ''}</td>
                      <td class="border px-3 py-2 text-xs font-mono">${v.walletAddress || ''}</td>
                      <td class="border px-3 py-2">${v.walletVerified ? '‚úÖ' : '‚Äî'}</td>
                      <td class="border px-3 py-2 text-xs font-mono">${v.lastVoteSignature ? v.lastVoteSignature.slice(0,12)+'‚Ä¶' : ''}</td>
                      <td class="border px-3 py-2 space-x-2">
                        <button class="text-indigo-600 text-sm" onclick='editVoter(${JSON.stringify(v).replace(/'/g,"&apos;")})'>Edit</button>
                        <button class="text-red-600 text-sm" onclick='deleteVoter(${v.id})'>Delete</button>
                      </td>`;
                    tbody.appendChild(tr);
                  });
            } catch {}
        }

        function openVoterModal() {
            document.getElementById('voterId').value = '';
            document.getElementById('voterModalTitle').textContent = 'Add Voter';
            document.getElementById('vName').value = '';
            document.getElementById('vMatric').value = '';
            document.getElementById('vEmail').value = '';
            document.getElementById('vDept').value = '';
            document.getElementById('vEligible').checked = true;
            document.getElementById('vVerified').checked = false;
            document.getElementById('voterModal').classList.remove('hidden');
        }

        function closeVoterModal() {
            const el = document.getElementById('voterModal');
            if (el) el.classList.add('hidden');
        }

        function editVoter(v) {
            document.getElementById('voterId').value = v.id;
            document.getElementById('voterModalTitle').textContent = 'Edit Voter';
            document.getElementById('vName').value = v.name || '';
            document.getElementById('vMatric').value = v.matric || '';
            document.getElementById('vEmail').value = v.email || '';
            document.getElementById('vDept').value = v.department || '';
            document.getElementById('vEligible').checked = !!v.eligible;
            document.getElementById('vVerified').checked = !!v.walletVerified;
            document.getElementById('voterModal').classList.remove('hidden');
        }

        async function deleteVoter(id) {
            if (!confirm('Delete this voter?')) return;
            try {
                await fetch(`http://localhost:8080/api/voters/${id}`, { method: 'DELETE', credentials: 'include' });
                refreshVoters();
            } catch {}
        }

        document.getElementById('voterForm')?.addEventListener('submit', async function(e) {
            e.preventDefault();
            const id = document.getElementById('voterId').value;
            const body = {
                name: document.getElementById('vName').value.trim(),
                matric: document.getElementById('vMatric').value.trim(),
                email: document.getElementById('vEmail').value.trim() || undefined,
                department: document.getElementById('vDept').value.trim() || undefined,
                walletVerified: document.getElementById('vVerified').checked,
                eligible: document.getElementById('vEligible').checked
            };
            try {
                const method = id ? 'PATCH' : 'POST';
                const url = id ? `http://localhost:8080/api/voters/${id}` : 'http://localhost:8080/api/voters';
                const resp = await fetch(url, { method, credentials: 'include', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
                if (!resp.ok) throw new Error('Failed');
                closeVoterModal();
                refreshVoters();
            } catch { alert('Failed to save voter'); }
        });

        // Refresh voters when opening admin panel
        document.getElementById('adminBtn').addEventListener('click', () => setTimeout(refreshVoters, 1000));

        function deleteElection(electionId) {
            if (confirm('Are you sure you want to delete this election? This will also delete all associated votes.')) {
                // Remove election from storage
                elections = elections.filter(e => e.id !== electionId);
                LocalStorageManager.saveElections(elections);
                
                // Remove associated votes
                const votes = LocalStorageManager.getVotes();
                const filteredVotes = votes.filter(v => v.electionId !== electionId);
                LocalStorageManager.saveVotes(filteredVotes);
                
                // Update current election if it was deleted
                currentElection = elections.find(e => e.status === 'active') || null;
                
                // Update all displays
                updateElectionTable();
                updateVotingInterface();
                refreshAdminData();
                alert('Election deleted successfully!');
            }
        }

        async function completeElection(id) {
            if (!confirm('Mark this election as COMPLETED?')) return;
            try {
                const resp = await fetch(`http://localhost:8080/admin/elections/${id}/status`, {
                    method: 'PATCH', credentials: 'include', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: 'COMPLETED' })
                });
                if (!resp.ok) throw new Error('Failed');
                updateElectionTable();
                refreshAdminData();
            } catch {
                alert('Failed to complete election');
            }
        }

        // Utility functions
        function generateWalletAddress() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            let result = '';
            for (let i = 0; i < 44; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        function generateTransactionId() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            let result = '';
            for (let i = 0; i < 64; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        function goBackToLogin() {
            document.getElementById('votingSection').classList.add('hidden');
            document.getElementById('loginSection').classList.remove('hidden');
            document.getElementById('voteConfirmation').classList.add('hidden');
            
            // Reset user state
            currentUser = null;
            walletConnected = false;
            hasVoted = false;
            document.getElementById('matricInput').value = '';
            document.getElementById('matricStatus').className = 'mt-2 text-sm hidden';
            document.getElementById('walletInfo').classList.add('hidden');
            const connectBtn = document.getElementById('connectWalletBtn');
            connectBtn.disabled = true;
            connectBtn.className = 'w-full bg-gray-300 text-gray-500 py-3 rounded-lg font-medium cursor-not-allowed transition-all';
            connectBtn.textContent = 'üîí Verify Matric First';
        }

        // Initialize voting section on page load
        updateVotingInterface();
        
        // Subscribe to live stats via SSE
        (function subscribeLive() {
            try {
                const electionId = currentElection?.id || 1;
                const evtSource = new EventSource(`http://localhost:8080/api/stream/${electionId}`);
                evtSource.onmessage = (e) => {
                    try {
                        const payload = JSON.parse(e.data);
                        if (payload?.type === 'stats' && Array.isArray(payload.stats)) {
                            currentElection.candidates.forEach(c => {
                                const row = payload.stats.find((s) => s.candidateId === c.id);
                                if (row) c.votes = row.votes;
                            });
                            currentElection.totalVotes = payload.stats.reduce((a, b) => a + (b.votes || 0), 0);
                            updateVoteDisplay();
                        }
                    } catch {}
                };
                evtSource.onerror = () => {
                    evtSource.close();
                    setTimeout(subscribeLive, 3000);
                };
            } catch {}
        })();
        
        // Debug: Check for wallet on page load
        window.addEventListener('load', function() {
            console.log('üîç Checking for wallets and libraries...');
            
            setTimeout(() => {
                // Check Solana Web3
                if (typeof window.solanaWeb3 !== 'undefined') {
                    console.log('‚úÖ Solana Web3.js loaded successfully');
                } else {
                    console.log('‚ùå Solana Web3.js failed to load');
                }
                
                // Check wallet
                const provider = window.detectWallet();
                if (provider) {
                    console.log('‚úÖ Wallet detected:', provider);
                    console.log('Wallet isPhantom:', provider.isPhantom);
                    console.log('Wallet isConnected:', provider.isConnected);
                } else {
                    console.log('‚ùå No wallet detected');
                    console.log('window.phantom:', window.phantom);
                    console.log('window.solana:', window.solana);
                }
                
                // List all providers
                const providers = Object.keys(window).filter(key => 
                    key.includes('phantom') || 
                    key.includes('solana') || 
                    key.includes('wallet')
                );
                console.log('Available providers:', providers);
            }, 2000); // Give more time for extensions to load
        });
    </script>
</body>
</html>
